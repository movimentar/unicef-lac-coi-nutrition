---
title: "Cost of Inaction Simulation Report"
date: "`r format(Sys.Date(), '%d %B %Y')`"
output:
  html_document:
    theme: flatly
    self_contained: true
    toc: true
    toc_float: true
params:
  summary_df: NA
  results: NA
  direct_df: NA
  narrative_html: NA   # optional HTML string from Gemini
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(tidyverse)
library(scales)
library(gt)
library(htmltools)

options(dplyr.summarise.inform = FALSE)

UNICEF_CYAN <- "#1CABE2"
fmt_dollar <- function(x) if (is.null(x) || all(is.na(x))) "—" else dollar(round(x, 0))
fmt_comma  <- function(x) if (is.null(x) || all(is.na(x))) "—" else comma(round(x, 0))

# Clean labels and display order for summary table
label_map <- c(
  emergency               = "Emergency",
  pin_children_u5         = "PiN — Children 0–59m",
  pin_plw                 = "PiN — PLW",
  coverage_pct            = "Target coverage (%)",
  valuation               = "Valuation (indirect benefits)",
  planning_years          = "Planning period (years)",
  total_cost_usd          = "Total response cost (2015 USD)",
  indirect_benefit_usd    = "Indirect benefits (2015 USD)",
  direct_benefit_count    = "Direct benefits — headline (count)",
  bcr                     = "Benefit–Cost Ratio"
)
display_order <- names(label_map)

# Safely coerce summary_df (1-row tibble) into key–value with nice labels & formatting
ensure_kv <- function(df){
  if (!is.data.frame(df) || nrow(df) == 0) return(NULL)
  row <- df %>% slice(1)

  # ensure character values for non-numeric fields and keep numerics as-is
  vals <- map(names(row), function(nm) row[[nm]][[1]])

  pretty_value <- function(key, v){
    # format by field, not by text patterns (avoids $ on direct_benefit_count)
    if (key %in% c("total_cost_usd","indirect_benefit_usd")) {
      return(dollar(round(as.numeric(v), 2)))
    }
    if (key %in% c("pin_children_u5","pin_plw","planning_years","direct_benefit_count")) {
      return(comma(round(as.numeric(v), 0)))
    }
    if (key == "coverage_pct") {
      return(paste0(round(as.numeric(v), 0), "%"))
    }
    if (key == "bcr") {
      n <- suppressWarnings(as.numeric(v))
      return(if (is.na(n)) "—" else sprintf("%.2f", n))
    }
    if (key == "valuation") {
      return(dplyr::recode(as.character(v),
                           undisc = "Undiscounted",
                           pv3    = "PV (3%)",
                           pv5    = "PV (5%)",
                           .default = as.character(v)))
    }
    as.character(v)
  }

  kv <- tibble(
    key   = names(row),
    Item  = dplyr::recode(names(row), !!!label_map, .default = names(row)),
    Value = map2_chr(names(row), vals, pretty_value)
  )

  # order nicely: known keys first, then anything extra
  kv <- kv %>%
    mutate(order = match(key, display_order)) %>%
    arrange(is.na(order), order, Item) %>%
    select(Item, Value)

  kv
}
```

<style>
  body { font-family: 'Lato', sans-serif; padding: 2em; }
  .main-container { max-width: 1100px; margin: auto; }
  .print-button { float: right; padding: 8px 12px; background-color: #1CABE2; color: white; border-radius: 5px; text-decoration: none; }
  @media print { .print-button { display: none; } }
  .kpi-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin: 10px 0 24px 0; }
  .kpi { background: #f8f9fa; border: 1px solid #e5e7eb; border-radius: 8px; padding: 14px 16px; }
  .kpi h3 { margin: 0 0 6px 0; font-size: 0.95rem; font-weight: 700; color: #6b7280; }
  .kpi .val { font-size: 1.6rem; font-weight: 800; color: #111827; }
  .note { font-size: 0.92rem; color: #6b7280; }
  .callout { border-left: 4px solid #1CABE2; background: #f0f9ff; padding: 10px 14px; border-radius: 6px; }
</style>

<a href="javascript:window.print()" class="print-button">
  <i class="fa fa-print"></i> Print or Save as PDF
</a>

# Executive summary

This report summarises the outputs of the **Cost of Inaction (CoI) – Nutrition in Emergencies** simulation for the selected scenario.

```{r kpis}
res <- params$results
if (is.list(res)) {
  bcr_txt <- if (is.null(res$bcr) || is.na(res$bcr)) "—" else sprintf("%.2f", res$bcr)
  browsable(tagList(
    div(class="kpi-grid",
      div(class="kpi",
        h3("Total response cost (2015 USD)"),
        div(class="val", fmt_dollar(res$cost_total))
      ),
      div(class="kpi",
        h3("Indirect benefits (2015 USD)"),
        div(class="val", fmt_dollar(res$indir_total))
      ),
      div(class="kpi",
        h3("Benefit–Cost Ratio"),
        div(class="val", bcr_txt)
      )
    )
  ))
} else {
  HTML('<p class="note">No results were provided to the report.</p>')
}
```

<div class="note">
<strong>Interpretation:</strong> Indirect benefits reflect economic value from improved nutrition outcomes.
Direct benefits (cases averted/improved) are listed below by indicator.
</div>

<div class="callout" style="margin-top:8px">
  The figures in this simulation may differ from those published in the study report.
  Results reflect the scenario inputs selected in the app (coverage, People in Need,
  package composition and any unit-cost overrides) and are scaled to the chosen planning period.
</div>


---

# Interpretation via artificial intelligence (Gemini)

```{r ai_block, results='asis'}
nh <- params$narrative_html
if (is.character(nh) && nzchar(nh)) {
  cat(nh)
} else {
  cat('<p class="note">No AI interpretation was generated in the app for this scenario.</p>')
}
```

---

# Scenario parameters & key results

```{r summary_table}
df <- ensure_kv(params$summary_df)
if (is.data.frame(df) && nrow(df)) {
  df %>%
    gt() %>%
    tab_header(title = "Scenario parameters & key results") %>%
    cols_align("left",  columns = Item) %>%
    cols_align("right", columns = Value)
} else {
  HTML('<p class="note">Summary parameters were not provided.</p>')
}
```

---

# Cost vs. indirect benefits

The chart below compares the **total response cost** and the **indirect (economic) benefits** over the planning period.

```{r benefit_plot, fig.align='center'}
if (is.list(res) && all(c("indir_total","cost_total") %in% names(res))) {
  df_plot <- tibble(
    metric = factor(c("Indirect benefits", "Cost"),
                    levels = c("Indirect benefits", "Cost")),
    usd = c(res$indir_total %||% NA_real_, res$cost_total %||% NA_real_)
  )
  ggplot(df_plot, aes(x = metric, y = usd, fill = metric)) +
    geom_col(width = 0.6, show.legend = FALSE, na.rm = TRUE) +
    scale_fill_manual(values = c("Indirect benefits" = UNICEF_CYAN, "Cost" = "#6c757d")) +
    scale_y_continuous(labels = label_dollar()) +
    labs(x = NULL, y = "Value (2015 USD)", title = "Cost vs. benefit over the planning period") +
    theme_minimal(base_size = 13) +
    theme(plot.title = element_text(face = "bold"))
} else {
  HTML('<p class="note">Insufficient data to plot costs and benefits.</p>')
}
```

---

# Direct benefits

## Top indicators (planning period)

```{r top_indicators}
dd <- params$direct_df
if (is.data.frame(dd) && nrow(dd)) {
  top <- dd %>% arrange(desc(total_planning)) %>% slice_head(n = 10) %>%
    select(indicator_category, indicator_name, total_planning, per_year)
  top %>%
    mutate(total_planning = comma(total_planning),
           per_year = comma(per_year)) %>%
    gt() %>%
    tab_header(title = "Top indicators by total cases averted / improved") %>%
    cols_label(
      indicator_category = "Category",
      indicator_name = "Indicator",
      total_planning = "Total over period",
      per_year = "Per year (avg)"
    ) %>%
    cols_align("center", columns = c(total_planning, per_year))
} else {
  HTML('<p class="note">No direct indicator table was provided.</p>')
}
```

## By category

```{r category_bars, fig.height=3.8}
if (is.data.frame(dd) && nrow(dd)) {
  cat_sum <- dd %>%
    group_by(indicator_category) %>%
    summarise(total = sum(total_planning, na.rm = TRUE), .groups = "drop")
  ggplot(cat_sum, aes(reorder(indicator_category, total), total)) +
    geom_col(fill = UNICEF_CYAN, width = 0.6) +
    coord_flip() +
    scale_y_continuous(labels = comma) +
    labs(x = NULL, y = "Total cases over period", title = "Direct benefits by category") +
    theme_minimal(base_size = 12) +
    theme(plot.title = element_text(face = "bold"))
}
```

## Full indicator table

```{r direct_table}
if (is.data.frame(dd) && nrow(dd)) {
  dd %>%
    gt(groupname_col = "indicator_category", rowname_col = "indicator_name") %>%
    tab_header(title = "Estimated direct benefits by indicator") %>%
    cols_hide(columns = c(study_total)) %>%
    cols_label(per_year = "Per year", total_planning = "Total over period") %>%
    fmt_number(columns = c(per_year, total_planning), decimals = 0) %>%
    tab_options(table.font.size = "small")
}
```

---

# Methods (short)

<div class="callout">
<ul>
<li><strong>Coverage interpolation:</strong> results are interpolated piece-wise linearly between 0→30→95% anchors.</li>
<li><strong>PiN scaling:</strong> indicators tied to children or PLW are scaled by the user-supplied People in Need (PiN).</li>
<li><strong>Annualisation & planning period:</strong> totals are annualised with the study duration and scaled to the planning years.</li>
<li><strong>Costs:</strong> proportional to coverage and PiN; unit-cost overrides, if any, are applied per intervention.</li>
<li><strong>Economic benefits:</strong> avoided formula costs (0–24 months) and projected lifetime earnings (2038–2080); optional PV discounting.</li>
</ul>
</div>

---
<div class="callout" style="margin-top:8px">
  <strong>Disclaimer:</strong> This tool was developed by movimentar GmbH (https://www.movimentar.eu) under a study commissioned by UNICEF’s Latin America and Caribbean Regional Office (LACRO). It has not been formally reviewed or endorsed by UNICEF.

The analyses, views, findings and conclusions are those of movimentar GmbH and do not necessarily reflect the policies or positions of UNICEF, its Executive Board, Member States, or any United Nations entity. Responsibility for any errors or omissions rests solely with the authors.

Publication or dissemination on UNICEF’s official platforms is determined exclusively by UNICEF and is subject to its internal procedures.

This tool and repository are provided for information and planning purposes. Results are model-based and may differ from figures in official UNICEF publications or country reports; no warranty is given as to completeness or accuracy.
</div>

*Report generated on* `r format(Sys.time(), "%Y-%m-%d %H:%M")`.

